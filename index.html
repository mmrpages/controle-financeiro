<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Financeiro 2026 - Sky Edition</title>
    <link rel="stylesheet" href="style.css">
    <!-- Chart.js √© usado para o gr√°fico de pizza por m√™s -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Carregando...</p>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <div class="container" style="display: none;">
        <header>
            <h1>Finan√ßas 2026</h1>
            <div class="toolbar">
                <button class="btn btn-accent" type="button" onclick="addExpense()">+ Despesa</button>
                <button class="btn btn-warning" onclick="buyPremium()" id="premiumBtn">
                    üöÄ Premium R$ 9,90/m√™s
                </button>
                <button class="btn btn-secondary" type="button" onclick="logout()">Sair</button>
                <button class="btn btn-danger" type="button" onclick="resetAll()">Limpar Tudo</button>
            </div>
        </header>

        <div class="table-card">
            <div class="table-wrap">
                <table>
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="grid-info">
            <div class="card">
                <h4>Receita Anual</h4>
                <div id="totalRenda" class="value">R$ 0,00</div>
            </div>
            <div class="card">
                <h4>Despesa Anual</h4>
                <div id="totalGasto" class="value value-danger">R$ 0,00</div>
            </div>
            <div class="card">
                <h4>M√©dia Saldo</h4>
                <div id="mediaSaldo" class="value value-success">R$ 0,00</div>
            </div>
            <div class="card">
                <h4>Uso da Renda</h4>
                <div id="mediaPerc" class="value">0%</div>
            </div>
        </div>
    </div>

    <!-- Modal de Gr√°fico por Categoria -->
    <div id="chartModal" class="modal" aria-hidden="true">
        <div class="modal-content" style="max-width: 600px;">
            <h2 id="modalTitle" style="margin-bottom: 20px;"></h2>
            <div class="chart-container" style="position: relative; height:350px; width:100%">
                <canvas id="categoryChart"></canvas>
            </div>
            <div id="modalTotal" class="modal-total"></div>
            <button class="btn btn-block" type="button" onclick="closeChartModal()">Fechar</button>
        </div>
    </div>

    <!-- Modal de Nova/Editar Despesa -->
    <div id="dataModal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <h2 id="dataModalTitle">Nova Despesa</h2>
            <div class="form-group">
                <label for="inputExpenseName">Nome da Despesa</label>
                <input type="text"
                       id="inputExpenseName"
                       class="input"
                       placeholder="Ex: Internet"
                       maxlength="50">

                <label for="inputExpenseCategory">Categoria</label>
                <select id="inputExpenseCategory" class="input"></select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" type="button" onclick="closeDataModal()">Cancelar</button>
                <button class="btn btn-accent" type="button" id="btnSaveData">Salvar</button>
            </div>
        </div>
    </div>

    <!-- script.js exp√µe fun√ß√µes globais (addExpense, resetAll, modais, build etc.) -->
    <script src="script.obf.js"></script>
    <!-- M√≥dulo de inicializa√ß√£o Firebase + Auth + Firestore -->
    <script type="module">
        import firebaseConfig from './config.js';

        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app);
        window.db = getFirestore(app);
        window.fbOps = { doc, setDoc, getDoc };

        console.log('üî• Firebase inicializado');

        onAuthStateChanged(window.auth, async (user) => {
            if (!user) {
                console.log('üë§ Nenhum usu√°rio - redirecionando para login');
                window.location.href = 'login.html';
                return;
            }

            console.log('‚úÖ Usu√°rio autenticado:', user.email);

            try {
                if (window.showLoading) window.showLoading();

                await loadUserData(user.uid);

                const container = document.querySelector('.container');
                if (container) {
                    container.style.display = 'block';
                    console.log('‚úÖ Container exibido');
                }

                if (window.hideLoading) window.hideLoading();

                // Define fun√ß√£o de logout global
                window.logout = async () => {
                    try {
                        if (window.showLoading) window.showLoading();
                        await signOut(window.auth);
                        window.location.href = 'login.html';
                    } catch (error) {
                        if (window.showToast) {
                            window.showToast('Erro ao sair: ' + error.message, 'error');
                        }
                        if (window.hideLoading) window.hideLoading();
                    }
                };
            } catch (error) {
                console.error('‚ùå Erro ao carregar:', error);
                if (window.showToast) {
                    window.showToast('Erro ao carregar dados: ' + error.message, 'error');
                } else {
                    alert('Erro ao carregar dados: ' + error.message);
                }
                if (window.hideLoading) window.hideLoading();
            }
        });

        async function loadUserData(uid) {
            try {
                console.log('üìä Carregando dados do usu√°rio:', uid);
                const docRef = doc(window.db, "usuarios", uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.updateStateFromFirebase(data);

                    // ‚úÖ VERIFICA PREMIUM AQUI
                    state.isPremium = data.isPremium || false;
                    updatePremiumUI();

                } else {
                    // Novo usu√°rio
                    setTimeout(async () => {
                        await window.saveToFirebase();
                    }, 100);
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar:', error);
            }
        }
            </script>
    </body>
</html>
