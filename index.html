<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Financeiro 2026 - Sky Edition</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="spinner"></div>
  <p>Carregando...</p>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast"></div>

<div class="container" style="display: none;"> 
  <header>
    <h1>Finanças 2026</h1>
    <div class="toolbar">
      <button class="btn btn-accent" onclick="addExpense()">+ Despesa</button>
      <button class="btn btn-secondary" onclick="logout()">Sair</button>
      <button class="btn btn-danger" onclick="resetAll()">Limpar Tudo</button>
    </div>
  </header>

  <div class="table-card">
    <div class="table-wrap">
      <table>
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <div class="grid-info">
    <div class="card">
      <h4>Receita Anual</h4>
      <div id="totalRenda" class="value">R$ 0,00</div>
    </div>
    <div class="card">
      <h4>Despesa Anual</h4>
      <div id="totalGasto" class="value value-danger">R$ 0,00</div>
    </div>
    <div class="card">
      <h4>Média Saldo</h4>
      <div id="mediaSaldo" class="value value-success">R$ 0,00</div>
    </div>
    <div class="card">
      <h4>Uso da Renda</h4>
      <div id="mediaPerc" class="value">0%</div>
    </div>
  </div>
</div>

<!-- Modal de Gráfico por Categoria -->
<div id="chartModal" class="modal">
  <div class="modal-content" style="max-width: 600px;">
    <h2 id="modalTitle" style="margin-bottom: 20px;"></h2>
    <div class="chart-container" style="position: relative; height:350px; width:100%">
      <canvas id="categoryChart"></canvas>
    </div>
    <div id="modalTotal" class="modal-total"></div>
    <button class="btn btn-block" onclick="closeChartModal()">Fechar</button>
  </div>
</div>

<!-- Modal de Nova/Editar Despesa -->
<div id="dataModal" class="modal">
  <div class="modal-content">
    <h2 id="dataModalTitle">Nova Despesa</h2>
    <div class="form-group">
      <label for="inputExpenseName">Nome da Despesa</label>
      <input 
        type="text" 
        id="inputExpenseName" 
        class="input" 
        placeholder="Ex: Internet"
        maxlength="50"
      >
      
      <label for="inputExpenseCategory">Categoria</label>
      <select id="inputExpenseCategory" class="input"></select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeDataModal()">Cancelar</button>
      <button class="btn btn-accent" id="btnSaveData">Salvar</button>
    </div>
  </div>
</div>

<script type="module">
  import firebaseConfig from './config.js'; 
  
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  window.auth = getAuth(app);
  window.db = getFirestore(app);
  window.fbOps = { doc, setDoc, getDoc };

  onAuthStateChanged(window.auth, async (user) => {
    if (!user) {
      window.location.href = 'login.html';
    } else {
      try {
        window.showLoading();
        await loadUserData(user.uid);
        document.querySelector('.container').style.display = 'block';
        window.hideLoading();
        
        // Define função de logout
        window.logout = async () => {
          try {
            window.showLoading();
            await signOut(window.auth);
            window.location.href = 'login.html';
          } catch (error) {
            window.showToast('Erro ao sair: ' + error.message, 'error');
            window.hideLoading();
          }
        };
      } catch (error) {
        window.showToast('Erro ao carregar dados: ' + error.message, 'error');
        window.hideLoading();
      }
    }
  });

  async function loadUserData(uid) {
    try {
      const docRef = doc(window.db, "usuarios", uid);
      const docSnap = await getDoc(docRef);
      
      if (docSnap.exists()) {
        window.updateStateFromFirebase(docSnap.data());
      } else {
        console.log('Novo usuário - inicializando dados padrão');
        // Salva estado inicial no Firebase
        await window.saveToFirebase();
      }
    } catch (error) {
      console.error('Erro ao carregar dados do usuário:', error);
      throw error;
    }
  }
</script>

<script src="script.js" defer></script>
</body>
</html>
