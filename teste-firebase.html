<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teste Firebase - Diagn√≥stico</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #667eea;
      margin-bottom: 10px;
    }
    p {
      color: #64748b;
      margin-bottom: 30px;
    }
    .test-section {
      background: #f8fafc;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border-left: 4px solid #cbd5e1;
    }
    .test-section.success {
      border-left-color: #10b981;
      background: #d1fae5;
    }
    .test-section.error {
      border-left-color: #ef4444;
      background: #fee2e2;
    }
    .test-section h3 {
      margin-bottom: 10px;
      color: #1e293b;
    }
    .result {
      font-family: monospace;
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    .btn:hover {
      background: #5568d3;
    }
    .btn-success {
      background: #10b981;
    }
    .btn-danger {
      background: #ef4444;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }
    .status-ok {
      background: #d1fae5;
      color: #065f46;
    }
    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }
    .status-waiting {
      background: #fef3c7;
      color: #92400e;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>üî• Diagn√≥stico Firebase</h1>
  <p>Esta p√°gina testa a conex√£o com o Firebase e Firestore</p>

  <!-- Status Geral -->
  <div class="test-section" id="section-status">
    <h3>üìä Status Geral</h3>
    <div id="status-firebase">Firebase: <span class="status status-waiting">Carregando...</span></div>
    <div id="status-auth">Auth: <span class="status status-waiting">Carregando...</span></div>
    <div id="status-firestore">Firestore: <span class="status status-waiting">Carregando...</span></div>
    <div id="status-user">Usu√°rio: <span class="status status-waiting">Aguardando login...</span></div>
  </div>

  <!-- Login -->
  <div class="test-section">
    <h3>üîê Autentica√ß√£o</h3>
    <input type="email" id="test-email" placeholder="seu-email@exemplo.com" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; width: 100%; margin-bottom: 10px;">
    <input type="password" id="test-password" placeholder="senha (m√≠n. 6 caracteres)" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; width: 100%; margin-bottom: 10px;">
    <button class="btn" onclick="testarLogin()">Login</button>
    <button class="btn" onclick="testarCriarConta()">Criar Conta</button>
    <button class="btn btn-danger" onclick="testarLogout()">Logout</button>
    <div class="result" id="result-auth"></div>
  </div>

  <!-- Teste de Escrita -->
  <div class="test-section">
    <h3>‚úçÔ∏è Teste de Escrita no Firestore</h3>
    <button class="btn btn-success" onclick="testarEscrita()">Escrever Dados</button>
    <div class="result" id="result-write"></div>
  </div>

  <!-- Teste de Leitura -->
  <div class="test-section">
    <h3>üìñ Teste de Leitura do Firestore</h3>
    <button class="btn btn-success" onclick="testarLeitura()">Ler Dados</button>
    <div class="result" id="result-read"></div>
  </div>

  <!-- Diagn√≥stico Completo -->
  <div class="test-section">
    <h3>üîç Diagn√≥stico Completo</h3>
    <button class="btn" onclick="diagnosticoCompleto()">Executar Diagn√≥stico</button>
    <div class="result" id="result-diagnostic"></div>
  </div>
</div>

<script type="module">
  import firebaseConfig from './config.js';
  
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  // Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  window.auth = auth;
  window.db = db;

  // Atualizar status
  function updateStatus(id, text, isOk) {
    const el = document.getElementById(id);
    const statusClass = isOk ? 'status-ok' : 'status-error';
    const statusText = isOk ? '‚úÖ' : '‚ùå';
    el.innerHTML = text + `: <span class="status ${statusClass}">${statusText}</span>`;
  }

  // Verificar Firebase carregado
  setTimeout(() => {
    updateStatus('status-firebase', 'Firebase', true);
    updateStatus('status-auth', 'Auth', auth !== null);
    updateStatus('status-firestore', 'Firestore', db !== null);
  }, 1000);

  // Monitorar autentica√ß√£o
  onAuthStateChanged(auth, (user) => {
    if (user) {
      updateStatus('status-user', `Usu√°rio: ${user.email}`, true);
      document.getElementById('section-status').className = 'test-section success';
    } else {
      updateStatus('status-user', 'Usu√°rio', false);
    }
  });

  // Login
  window.testarLogin = async () => {
    const email = document.getElementById('test-email').value;
    const password = document.getElementById('test-password').value;
    const resultDiv = document.getElementById('result-auth');
    
    try {
      resultDiv.textContent = 'Tentando fazer login...\n';
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      resultDiv.textContent += `‚úÖ Login realizado com sucesso!\nUID: ${userCredential.user.uid}\nEmail: ${userCredential.user.email}`;
    } catch (error) {
      resultDiv.textContent += `‚ùå Erro no login:\nC√≥digo: ${error.code}\nMensagem: ${error.message}`;
    }
  };

  // Criar conta
  window.testarCriarConta = async () => {
    const email = document.getElementById('test-email').value;
    const password = document.getElementById('test-password').value;
    const resultDiv = document.getElementById('result-auth');
    
    try {
      resultDiv.textContent = 'Criando conta...\n';
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      resultDiv.textContent += `‚úÖ Conta criada com sucesso!\nUID: ${userCredential.user.uid}\nEmail: ${userCredential.user.email}`;
    } catch (error) {
      resultDiv.textContent += `‚ùå Erro ao criar conta:\nC√≥digo: ${error.code}\nMensagem: ${error.message}`;
    }
  };

  // Logout
  window.testarLogout = async () => {
    const resultDiv = document.getElementById('result-auth');
    try {
      await signOut(auth);
      resultDiv.textContent = '‚úÖ Logout realizado com sucesso!';
    } catch (error) {
      resultDiv.textContent = `‚ùå Erro no logout: ${error.message}`;
    }
  };

  // Testar escrita
  window.testarEscrita = async () => {
    const resultDiv = document.getElementById('result-write');
    
    if (!auth.currentUser) {
      resultDiv.textContent = '‚ùå Voc√™ precisa fazer login primeiro!';
      return;
    }

    try {
      resultDiv.textContent = 'Tentando escrever no Firestore...\n';
      
      const dadosTeste = {
        teste: true,
        timestamp: new Date().toISOString(),
        mensagem: "Teste de escrita",
        categorias: ["Teste1", "Teste2"],
        valor: 123.45
      };

      await setDoc(
        doc(db, "usuarios", auth.currentUser.uid),
        dadosTeste,
        { merge: true }
      );

      resultDiv.textContent += `‚úÖ Dados escritos com sucesso!\n\nDados salvos:\n${JSON.stringify(dadosTeste, null, 2)}`;
    } catch (error) {
      resultDiv.textContent += `‚ùå Erro ao escrever:\n\nC√≥digo: ${error.code}\nMensagem: ${error.message}\n\nPoss√≠veis causas:\n1. Regras do Firestore bloqueando acesso\n2. Usu√°rio n√£o autenticado\n3. Problema de permiss√£o`;
    }
  };

  // Testar leitura
  window.testarLeitura = async () => {
    const resultDiv = document.getElementById('result-read');
    
    if (!auth.currentUser) {
      resultDiv.textContent = '‚ùå Voc√™ precisa fazer login primeiro!';
      return;
    }

    try {
      resultDiv.textContent = 'Tentando ler do Firestore...\n';
      
      const docSnap = await getDoc(doc(db, "usuarios", auth.currentUser.uid));

      if (docSnap.exists()) {
        resultDiv.textContent += `‚úÖ Dados lidos com sucesso!\n\nDados encontrados:\n${JSON.stringify(docSnap.data(), null, 2)}`;
      } else {
        resultDiv.textContent += '‚ö†Ô∏è Documento n√£o existe ainda.\n\nFa√ßa o teste de escrita primeiro!';
      }
    } catch (error) {
      resultDiv.textContent += `‚ùå Erro ao ler:\n\nC√≥digo: ${error.code}\nMensagem: ${error.message}\n\nPoss√≠veis causas:\n1. Regras do Firestore bloqueando acesso\n2. Documento n√£o existe\n3. Problema de permiss√£o`;
    }
  };

  // Diagn√≥stico completo
  window.diagnosticoCompleto = async () => {
    const resultDiv = document.getElementById('result-diagnostic');
    let diagnostico = '=== DIAGN√ìSTICO COMPLETO ===\n\n';

    // 1. Firebase
    diagnostico += '1. FIREBASE\n';
    diagnostico += `   Carregado: ${typeof firebase !== 'undefined' ? '‚úÖ' : '‚ùå'}\n`;
    diagnostico += `   Auth: ${auth ? '‚úÖ' : '‚ùå'}\n`;
    diagnostico += `   Firestore: ${db ? '‚úÖ' : '‚ùå'}\n\n`;

    // 2. Autentica√ß√£o
    diagnostico += '2. AUTENTICA√á√ÉO\n';
    const user = auth.currentUser;
    diagnostico += `   Usu√°rio logado: ${user ? '‚úÖ' : '‚ùå'}\n`;
    if (user) {
      diagnostico += `   UID: ${user.uid}\n`;
      diagnostico += `   Email: ${user.email}\n`;
      diagnostico += `   Email verificado: ${user.emailVerified ? '‚úÖ' : '‚ùå'}\n`;
    }
    diagnostico += '\n';

    // 3. Configura√ß√£o
    diagnostico += '3. CONFIGURA√á√ÉO\n';
    diagnostico += `   Project ID: ${db._databaseId?.projectId || 'N/A'}\n`;
    diagnostico += `   Database: ${db._databaseId?.database || 'N/A'}\n\n`;

    // 4. Teste de conex√£o
    diagnostico += '4. TESTE DE CONEX√ÉO\n';
    if (user) {
      try {
        const testDoc = await getDoc(doc(db, "usuarios", user.uid));
        diagnostico += `   Conex√£o Firestore: ‚úÖ\n`;
        diagnostico += `   Documento existe: ${testDoc.exists() ? '‚úÖ' : '‚ùå'}\n`;
        if (testDoc.exists()) {
          diagnostico += `   Tamanho dos dados: ${JSON.stringify(testDoc.data()).length} bytes\n`;
        }
      } catch (e) {
        diagnostico += `   Conex√£o Firestore: ‚ùå\n`;
        diagnostico += `   Erro: ${e.code} - ${e.message}\n`;
      }
    } else {
      diagnostico += `   Fa√ßa login para testar a conex√£o\n`;
    }

    diagnostico += '\n=== FIM DO DIAGN√ìSTICO ===';
    resultDiv.textContent = diagnostico;
  };
</script>

</body>
</html>
