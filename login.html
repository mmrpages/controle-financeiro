<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Finan√ßas 2026</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="auth-card" role="form" aria-labelledby="authTitle">
    <h2 id="authTitle">Acessar Sistema</h2>
    <p id="authSubtitle">Entre com seu e-mail e senha</p>

    <div id="errorMessage" class="error-message" aria-live="polite"></div>

    <!-- Form corrige warning do input fora de form -->
    <form onsubmit="handleAuth(); return false;">
      <input type="email" id="email" class="auth-input" placeholder="Seu e-mail" autocomplete="email" required>
      <input type="password" id="password" class="auth-input" placeholder="Sua senha (m√≠n. 8 caracteres)" autocomplete="current-password" required minlength="8">
      <button id="mainBtn" class="auth-btn" type="submit">Entrar</button>
    </form>

    <!-- Esqueci minha senha -->
    <div class="auth-toggle" onclick="forgotPasswordPrompt()">Esqueceu a senha? <b>Recuperar</b></div>

    <!-- Alternar login/cadastro -->
    <div class="auth-toggle" onclick="toggleMode()" id="toggleText">
      N√£o tem conta? <b>Criar agora</b>
    </div>
  </div>

  <script type="module">
    import firebaseConfig from './config.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      sendPasswordResetEmail,
      updatePassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    let isLogin = true;

    // Alternar login/cadastro
    window.toggleMode = () => {
      isLogin = !isLogin;
      document.getElementById('authTitle').innerText = isLogin ? "Acessar Sistema" : "Criar Conta";
      document.getElementById('authSubtitle').innerText = isLogin ? "Entre com seu e-mail e senha" : "Crie sua conta gratuitamente";
      document.getElementById('mainBtn').innerText = isLogin ? "Entrar" : "Cadastrar";
      document.getElementById('toggleText').innerHTML = isLogin
        ? "N√£o tem conta? <b>Criar agora</b>"
        : "J√° tem conta? <b>Fazer Login</b>";
      hideError();
    };

    // Exibir erros
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.add('show');
    }
    function hideError() {
      document.getElementById('errorMessage').classList.remove('show');
    }

    // Valida√ß√£o de senha forte
    function isStrongPassword(password) {
      const strongRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&]).{8,}$/;
      return strongRegex.test(password);
    }

    // Login/Cadastro
    window.handleAuth = async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      if (!email || !password) {
        showError('Por favor, preencha todos os campos');
        return;
      }
      if (!email.includes('@')) {
        showError('Por favor, insira um e-mail v√°lido');
        return;
      }
      if (!isStrongPassword(password)) {
        showError('A senha deve ter no m√≠nimo 8 caracteres, incluindo mai√∫sculas, min√∫sculas, n√∫meros e s√≠mbolos.');
        return;
      }

      hideError();
      try {
        if (isLogin) {
          await signInWithEmailAndPassword(auth, email, password);
        } else {
          await createUserWithEmailAndPassword(auth, email, password);
        }
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Erro de autentica√ß√£o:', error);
        showError("E-mail ou senha inv√°lidos"); // mensagem gen√©rica
      }
    };

    // Esqueci minha senha
    window.forgotPasswordPrompt = async () => {
      const email = document.getElementById('email').value.trim();
      if (!email) {
        showError("Digite seu e-mail para recuperar a senha");
        return;
      }
      try {
        await sendPasswordResetEmail(auth, email);
        alert("üìß Email de redefini√ß√£o enviado! Verifique sua caixa de entrada.");
      } catch (error) {
        console.error("Erro ao enviar email de redefini√ß√£o:", error);
        showError("Erro ao enviar email. Verifique se o e-mail est√° correto.");
      }
    };

    // Trocar senha (usu√°rio logado)
    window.changePassword = async () => {
      const newPassword = document.getElementById('newPassword').value;
      if (!isStrongPassword(newPassword)) {
        showError("A nova senha deve ser forte (m√≠n. 8 caracteres, mai√∫sculas, min√∫sculas, n√∫meros e s√≠mbolos).");
        return;
      }
      try {
        const user = auth.currentUser;
        if (!user) {
          showError("Usu√°rio n√£o autenticado");
          return;
        }
        await updatePassword(user, newPassword);
        alert("‚úÖ Senha atualizada com sucesso!");
      } catch (error) {
        console.error("Erro ao atualizar senha:", error);
        showError("Erro ao atualizar senha. Talvez seja necess√°rio fazer login novamente.");
      }
    };

    // Logout seguro
    window.logout = async () => {
      await signOut(auth);
      window.location.href = "login.html";
    };

    // Prote√ß√£o de sess√£o
    onAuthStateChanged(auth, (user) => {
      if (!user && window.location.pathname.includes("index.html")) {
        window.location.href = "login.html";
      }
    });
  </script>

</body>
</html>
